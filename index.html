<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Pilbox by agschwender</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Pilbox</h1>
          <h2>An image resizing application server</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/agschwender/pilbox/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/agschwender/pilbox/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/agschwender/pilbox" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a name="pilbox--" class="anchor" href="#pilbox--"><span class="octicon octicon-link"></span></a>Pilbox <a href="https://travis-ci.org/agschwender/pilbox"><img src="https://travis-ci.org/agschwender/pilbox.png" alt="Build Status"></a> <a href="https://coveralls.io/r/agschwender/pilbox"><img src="https://coveralls.io/repos/agschwender/pilbox/badge.png" alt="Coverage Status"></a>
</h1>

<p>Pilbox is an image resizing application server built on Python's <a href="http://www.tornadoweb.org/en/stable/">Tornado web framework</a> using the <a href="https://pypi.python.org/pypi/Pillow/2.1.0">Python Imaging Library (Pillow)</a>. It is not intended to be the primary source of images, but instead acts as a proxy which requests images and resizes them as desired.</p>

<h1>
<a name="setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h1>

<h2>
<a name="dependencies" class="anchor" href="#dependencies"><span class="octicon octicon-link"></span></a>Dependencies</h2>

<ul>
<li><a href="http://www.python.org/download/">Python 2.7</a></li>
<li><a href="https://pypi.python.org/pypi/Pillow/2.1.0">Pillow 2.1.0</a></li>
<li><a href="https://pypi.python.org/pypi/tornado/3.1">Tornado 3.1</a></li>
<li><a href="http://opencv.org/">OpenCV 2.x</a></li>
<li>Image Libraries: libjpeg-dev, libfreetype6, libfreetype6-dev, zlib1g-dev</li>
</ul><h2>
<a name="vagrant" class="anchor" href="#vagrant"><span class="octicon octicon-link"></span></a>Vagrant</h2>

<p>Packaged with Pilbox is a <a href="http://www.vagrantup.com/">Vagrant</a> configuration file which installs all necessary dependencies on a virtual box. See the <a href="http://docs.vagrantup.com/v2/installation/">Vagrant documentation for installation instructions</a>. Once installed, the following will start a virtual machine.</p>

<pre><code>$ vagrant up
</code></pre>

<p>To access the virtual machine itself, simply...</p>

<pre><code>$ vagrant ssh
</code></pre>

<h1>
<a name="running" class="anchor" href="#running"><span class="octicon octicon-link"></span></a>Running</h1>

<h2>
<a name="manual" class="anchor" href="#manual"><span class="octicon octicon-link"></span></a>Manual</h2>

<p>To run the application, issue the following command</p>

<pre><code>$ python -m pilbox.app
</code></pre>

<p>By default, this will run the application on port 8888 and can be accessed by visiting:</p>

<pre><code>http://localhost:8888/
</code></pre>

<p>To see a list of all available options, run</p>

<pre><code>$ python -m pilbox.app --help
Usage: pilbox/app.py [OPTIONS]

Options:

  --allowed_hosts            list of allowed image hosts (default [])
  --background               default bg color 3 or 6-digit hexadecimal
  --client_key               client key
  --client_name              client name
  --config                   path to configuration file
  --debug                    run in debug mode (default False)
  --filter                   default filter to use when resizing
  --help                     show this help information
  --port                     run on the given port (default 8888)
  --position                 default cropping position
  --quality                  default jpeg quality, 0-100
</code></pre>

<h2>
<a name="vagrant-1" class="anchor" href="#vagrant-1"><span class="octicon octicon-link"></span></a>Vagrant</h2>

<p>When running via Vagrant, the application is automatically started on port 8888 on 192.168.100.100, i.e.</p>

<pre><code>http://192.168.100.100:8888/
</code></pre>

<h1>
<a name="calling" class="anchor" href="#calling"><span class="octicon octicon-link"></span></a>Calling</h1>

<p>To use the image resizing service, include the application url as you would any other image. E.g. this image url</p>

<div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"http://i.imgur.com/zZ8XmBA.jpg"</span> <span class="nt">/&gt;</span>
</pre></div>

<p>Would be replaced with this image url</p>

<div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"http://localhost:8888/?url=http%3A%2F%2Fi.imgur.com%2FzZ8XmBA.jpg&amp;w=300&amp;h=300&amp;mode=crop"</span> <span class="nt">/&gt;</span>
</pre></div>

<p>This will request the image served at the supplied url and resize it to 300x300 using the crop mode. The following is the list of parameters that can be supplied to the service</p>

<ul>
<li>
<em>url</em>: The url of the image to be resized</li>
<li>
<em>w</em>: The desired width of the image</li>
<li>
<em>h</em>: The desired height of the image</li>
<li>
<em>mode</em>: The resizing method: clip, crop (default), fill and scale

<ul>
<li>
<em>clip</em>: Resize to fit within the desired region, keeping aspect ratio</li>
<li>
<em>crop</em>: Resize so one dimension fits within region, center, cut remaining</li>
<li>
<em>fill</em>: Fills the clipped space with a background color</li>
<li>
<em>scale</em>: Resize to fit within the desired region, ignoring aspect ratio</li>
</ul>
</li>
<li>
<em>filter</em>: The filtering algorithm used for resizing

<ul>
<li>
<em>nearest</em>: Fastest, but often images appear pixelated</li>
<li>
<em>bilinear</em>: Faster, can produce acceptable results</li>
<li>
<em>bicubic</em>: Fast, can produce acceptable results</li>
<li>
<em>antialias</em>: Slower, produces the best results</li>
</ul>
</li>
<li>
<em>bg</em>: Background color used with fill mode, 3- or 6-digit hexadecimal number</li>
<li>
<em>pos</em>: The crop position

<ul>
<li>
<em>top-left</em>: Crop from the top left</li>
<li>
<em>top</em>: Crop from the top center</li>
<li>
<em>top-right</em>: Crop from the top right</li>
<li>
<em>left</em>: Crop from the center left</li>
<li>
<em>center</em>: Crop from the center</li>
<li>
<em>right</em>: Crop from the center right</li>
<li>
<em>bottom-left</em>: Crop from the bottom left</li>
<li>
<em>bottom</em>: Crop from the bottom center</li>
<li>
<em>bottom-right</em>: Crop from the bottom right</li>
<li>
<em>face</em>: Identify faces and crop from the midpoint of their position(s)</li>
</ul>
</li>
<li>
<em>q</em>: The quality (1-100) used to save the image, only relevant to JPEGs.</li>
<li>
<em>client</em>: The client name</li>
<li>
<em>sig</em>: The signature</li>
</ul><p>The <code>url</code>, and either <code>w</code> or <code>h</code> parameters are required. If only one dimension is specified, the application will determine the other dimension using the aspect ratio. <code>mode</code> is optional and defaults to <code>crop</code>. <code>filter</code> is optional and defaults to <code>antialias</code>. <code>bg</code> is optional and defaults to <code>fff</code>. <code>pos</code> is optional and defaults to <code>center</code>. <code>q</code> is optional and default to <code>90</code>. <code>client</code> is required only if the <code>client_name</code> is defined within the configuration file. Likewise, <code>sig</code> is required only if the <code>client_key</code> is defined within the configuration file. See the <a href="#signing">signing section</a> for details on how to generate the signature.</p>

<h1>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples</h1>

<p>The following images show the various resizing modes in action for an original image size of <code>640x428</code> that is being resized to <code>500x400</code>.</p>

<h2>
<a name="clip" class="anchor" href="#clip"><span class="octicon octicon-link"></span></a>Clip</h2>

<p>The image is resized to fit within a <code>500x400</code> box, producing an image that is <code>500x334</code>. Clipping is useful when no portion of the image can be lost and it is acceptable that the image not be exactly the supplied dimensions, but merely fit within the dimensions.</p>

<p><img src="https://raw.github.com/agschwender/pilbox/master/pilbox/test/data/expected/example-500x400-clip.jpg" alt="Clipped image"></p>

<h2>
<a name="crop" class="anchor" href="#crop"><span class="octicon octicon-link"></span></a>Crop</h2>

<p>The image is resized so that one dimension fits within the <code>500x400</code> box. It is then centered and the excess is cut from the image. Cropping is useful when the position of the subject is known and the image must be exactly the supplied size.</p>

<p><img src="https://raw.github.com/agschwender/pilbox/master/pilbox/test/data/expected/example-500x400-crop.jpg" alt="Cropped image"></p>

<h2>
<a name="fill" class="anchor" href="#fill"><span class="octicon octicon-link"></span></a>Fill</h2>

<p>Similar to clip, fill resizes the image to fit within a <code>500x400</code> box. Once clipped, the image is centered within the box and all left over space is filled with the supplied background color. Filling is useful when no portion of the image can be lost and it must be exactly the supplied size.</p>

<p><img src="https://raw.github.com/agschwender/pilbox/master/pilbox/test/data/expected/example-500x400-fill-ccc.jpg" alt="Filled image"></p>

<h2>
<a name="scale" class="anchor" href="#scale"><span class="octicon octicon-link"></span></a>Scale</h2>

<p>The image is clipped to fit with the <code>500x400</code> box and then stretched to fill the excess space. Scaling is not often useful in production settings as it generally produces poor quality images. This mode is largely included for completeness.</p>

<p><img src="https://raw.github.com/agschwender/pilbox/master/pilbox/test/data/expected/example-500x400-scale.jpg" alt="Scale image"></p>

<h1>
<a name="testing" class="anchor" href="#testing"><span class="octicon octicon-link"></span></a>Testing</h1>

<p>To run all tests, issue the following command</p>

<pre><code>$ python -m pilbox.test.runtests
</code></pre>

<p>To run individual tests, simply indicate the test to be run, e.g.</p>

<pre><code>$ python -m pilbox.test.runtests pilbox.test.signature_test
</code></pre>

<h1>
<a name="signing" class="anchor" href="#signing"><span class="octicon octicon-link"></span></a>Signing</h1>

<p>In order to secure requests so that unknown third parties cannot easily use the resize service, the application can require that requests provide a signature. To enable this feature, set the <code>client_key</code> option. The signature is a hexadecimal digest generated from the client key and the query string using the HMAC-SHA1 message authentication code (MAC) algorithm. The below python code provides an example implementation.</p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>

<span class="k">def</span> <span class="nf">derive_signature</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>

<p>The signature is passed to the application by appending the <code>sig</code> paramater to the query string; e.g. <code>x=1&amp;y=2&amp;z=3&amp;sig=c9516346abf62876b6345817dba2f9a0c797ef26</code>. Note, the application does not include the leading question mark when verifying the supplied signature. To verify your signature implementation, see the <code>pilbox.signature</code> command described in the <a href="#tools">tools section</a>.</p>

<h1>
<a name="configuration" class="anchor" href="#configuration"><span class="octicon octicon-link"></span></a>Configuration</h1>

<p>All options that can be supplied to the application via the command line, can also be specified in the configuration file. Configuration files are simply python files that define the options as variables. The below is an example configuration.</p>

<pre><code># General settings
port = 8888

# Set client name and key if the application requires signed requests. The
# client must sign the request using the client_key, see README for
# instructions.
client_name = "sample"
client_key = "3NdajqH8mBLokepU4I2Bh6KK84GUf1lzjnuTdskY"

# Set the allowed hosts as an alternative to signed requests. Only those images
# which are served from the following hosts will be requested.
allowed_hosts = ["localhost"]

# Set default resizing options
background = "ccc"
filter = "bilinear"
position = "top"
quality = 90
</code></pre>

<h1>
<a name="tools" class="anchor" href="#tools"><span class="octicon octicon-link"></span></a>Tools</h1>

<p>To verify that your client application is generating correct signatures, use the signature command.</p>

<pre><code>$ python -m pilbox.signature --key=abcdef "x=1&amp;y=2&amp;z=3"
Query String: x=1&amp;y=2&amp;z=3
Signature: c9516346abf62876b6345817dba2f9a0c797ef26
Signed Query String: x=1&amp;y=2&amp;z=3&amp;sig=c9516346abf62876b6345817dba2f9a0c797ef26
</code></pre>

<p>The application allows the use of the resize functionality via the command line.</p>

<pre><code>$ python -m pilbox.image --width=300 --height=300 http://i.imgur.com/zZ8XmBA.jpg &gt; /tmp/foo.jpg
</code></pre>

<p>If a new mode is added or a modification was made to the libraries that would change the current expected output for tests, run the generate test command to regenerate the expected output for the test cases.</p>

<pre><code>$ python -m pilbox.test.genexpected
</code></pre>

<h1>
<a name="deploying" class="anchor" href="#deploying"><span class="octicon octicon-link"></span></a>Deploying</h1>

<p>The application itself does not include any caching. It is recommended that the application run behind a CDN for larger applications or behind varnish for smaller ones.</p>

<h1>
<a name="todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>TODO</h1>

<ul>
<li>How to reconcile unavailable color profiles?</li>
<li>Add backends (S3, file system, etc...) if necessary</li>
</ul>
        </section>

        <footer>
          Pilbox is maintained by <a href="https://github.com/agschwender">agschwender</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

                  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-8326371-5");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

      </div>
    </div>
  </body>
</html>